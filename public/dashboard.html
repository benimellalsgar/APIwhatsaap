<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp AI Agent - Multi User</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #25D366;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .status-inactive {
            background: #fee;
            color: #c33;
        }

        .status-active {
            background: #efe;
            color: #3c3;
        }

        .status-ready {
            background: #e7f7ff;
            color: #0066cc;
        }

        .qr-container {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }

        #qrCode {
            max-width: 300px;
            width: 100%;
            height: auto;
            margin: 20px auto;
            display: block;
        }

        .instructions {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .instructions ol {
            margin-left: 20px;
            color: #856404;
        }

        .instructions li {
            margin: 5px 0;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-start {
            background: #25D366;
            color: white;
        }

        .btn-start:hover {
            background: #1fb855;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }

        .btn-stop {
            background: #dc3545;
            color: white;
        }

        .btn-stop:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .message-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .message-log h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .message-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .message-received {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .message-sent {
            background: #f1f8e9;
            border-left: 4px solid #8bc34a;
        }

        .message-time {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25D366;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ WhatsApp AI Agent</h1>
        <p class="subtitle">Multi-Tenant SaaS Platform</p>

        <div id="botArea">
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="color: #25D366; margin: 0;">Welcome, <span id="displayUserId"></span>! üëã</h3>
                <span id="statusBadge" class="status-badge status-inactive">‚óè Inactive</span>
                <button id="logoutBtn" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; margin-top: 10px;">Logout</button>
            </div>

            <div id="alertContainer"></div>

            <div id="configArea" class="instructions" style="margin-bottom: 20px;">
                <h3>üì¶ Your Business Data</h3>
                <p>Tell the bot about your products, services, and prices</p>
                
                <textarea id="businessData" placeholder="Example:&#10;Products:&#10;- iPhone 15 Pro: 12000 DH&#10;- Samsung Galaxy S24: 9500 DH&#10;&#10;Services:&#10;- Delivery: 50 DH (Casablanca)&#10;&#10;Working hours: 9AM - 9PM" style="
                    width: 100%;
                    padding: 15px;
                    font-size: 1em;
                    border: 2px solid #ddd;
                    border-radius: 10px;
                    margin: 10px 0;
                    min-height: 150px;
                    font-family: inherit;
                    resize: vertical;
                "></textarea>
                
                <input type="text" id="apiKey" placeholder="Perplexity API Key (optional)" style="
                    width: 100%;
                    padding: 12px;
                    font-size: 0.9em;
                    border: 2px solid #ddd;
                    border-radius: 10px;
                    margin: 10px 0;
                ">
            </div>

            <div id="fileTestArea" class="instructions" style="margin-bottom: 20px;">
                <h3>üñºÔ∏è Test File Upload</h3>
                <p>Upload images, PDFs, audio, or video to test AI responses</p>
                
                <input type="file" id="fileInput" accept="image/*,application/pdf,audio/*,video/*" style="
                    width: 100%;
                    padding: 12px;
                    font-size: 0.9em;
                    border: 2px solid #ddd;
                    border-radius: 10px;
                    margin: 10px 0;
                ">
                
                <button id="uploadFileBtn" class="btn-action" style="width: 100%; margin-top: 10px;">
                    üì§ Upload & Test
                </button>
                
                <div id="uploadStatus" style="margin-top: 10px; font-size: 0.9em; color: #666;"></div>
            </div>

        <div id="qrArea" class="qr-container hidden">
            <h3>Scan QR Code</h3>
            <div class="loading">
                <div class="spinner"></div>
                <p>Generating QR Code...</p>
            </div>
            <img id="qrCode" class="hidden" alt="QR Code">
            
            <div class="instructions">
                <h3>üì± How to Scan:</h3>
                <ol>
                    <li>Open WhatsApp on your phone</li>
                    <li>Go to Settings ‚Üí Linked Devices</li>
                    <li>Tap "Link a Device"</li>
                    <li>Scan this QR code</li>
                </ol>
            </div>
        </div>

        <div id="readyArea" class="hidden">
            <div class="alert alert-success">
                ‚úÖ Bot is connected and ready! You can now receive AI-powered responses on WhatsApp.
            </div>
        </div>

        <div class="message-log hidden" id="messageLog">
            <h3>üì± Message Activity</h3>
            <div id="messageList"></div>
        </div>

            <button id="startBtn" class="btn-start">Start My Bot</button>
            <button id="stopBtn" class="btn-stop hidden">Stop My Bot</button>
            <button id="clearBtn" class="btn-stop hidden" style="background: #ff9800; margin-top: 10px;">üóëÔ∏è Clear Session (Logout)</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const tenant = JSON.parse(localStorage.getItem('tenant') || '{}');

        if (!token) {
            window.location.href = '/login';
        }

        let currentSessionId = null;
        const socket = io();
        const userIdInput = document.getElementById('userIdInput');
        const botArea = document.getElementById('botArea');
        const enterBtn = document.getElementById('enterBtn');
        const displayUserId = document.getElementById('displayUserId');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusBadge = document.getElementById('statusBadge');
        const qrArea = document.getElementById('qrArea');
        const qrCode = document.getElementById('qrCode');
        const readyArea = document.getElementById('readyArea');
        const alertContainer = document.getElementById('alertContainer');
        const messageLog = document.getElementById('messageLog');
        const messageList = document.getElementById('messageList');

        // Show user info and skip to bot area
        displayUserId.textContent = tenant.name || user.email;
        userIdInput.classList.add('hidden');
        botArea.classList.remove('hidden');

        // Check for existing sessions
        fetch('/api/sessions', {
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(data => {
            if (data.sessions && data.sessions.length > 0) {
                // Has existing session
                currentSessionId = data.sessions[0].session_id;
                socket.emit('join', currentSessionId);
                checkSessionStatus();
            }
        })
        .catch(err => console.error('Error loading sessions:', err));

        function checkSessionStatus() {
            if (!currentSessionId) return;
            
            fetch(`/api/status/${currentSessionId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => updateUI(data))
            .catch(err => console.error('Error checking status:', err));
        }

        // Auto-fill business data from saved config
        const businessData = document.getElementById('businessData');
        const apiKey = document.getElementById('apiKey');

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } catch (e) {}
                
                localStorage.clear();
                window.location.href = '/login';
            }
        });

        // Socket events
        socket.on('status', (data) => updateUI(data));

        socket.on('sessionStarted', () => {
            showAlert('Session started! Waiting for QR code...', 'info');
            updateStatus('active');
        });

        socket.on('qr', (data) => {
            qrArea.classList.remove('hidden');
            qrArea.querySelector('.loading').classList.add('hidden');
            qrCode.src = data.qrCode;
            qrCode.classList.remove('hidden');
        });

        socket.on('authenticated', () => {
            showAlert('Authentication successful!', 'success');
        });

        socket.on('ready', (data) => {
            qrArea.classList.add('hidden');
            readyArea.classList.remove('hidden');
            messageLog.classList.remove('hidden');
            updateStatus('ready');
            showAlert(data.message, 'success');
        });

        socket.on('messageReceived', (data) => {
            addMessage('received', data.from, data.message, data.timestamp);
        });

        socket.on('messageSent', (data) => {
            addMessage('sent', data.to, data.message, data.timestamp);
        });

        socket.on('disconnected', (data) => {
            showAlert('Disconnected: ' + data.reason, 'error');
            resetUI();
        });

        socket.on('authFailure', (data) => {
            showAlert('Authentication failed: ' + data.error, 'error');
            resetUI();
        });

        socket.on('sessionStopped', () => {
            showAlert('Session stopped successfully', 'info');
            resetUI();
        });

        socket.on('sessionCleared', () => {
            showAlert('Session cleared! You will need to scan QR code next time.', 'success');
            resetUI();
        });

        socket.on('error', (data) => {
            showAlert('Error: ' + data.message, 'error');
        });

        // Button handlers
        startBtn.addEventListener('click', async () => {
            const businessDataValue = businessData.value.trim();
            const apiKeyValue = apiKey.value.trim();
            
            if (!businessDataValue) {
                showAlert('Please enter your business data first', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/start', { 
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        config: {
                            businessData: businessDataValue,
                            apiKey: apiKeyValue || null
                        }
                    })
                });
                const data = await res.json();
                
                if (res.ok) {
                    currentSessionId = data.sessionId;
                    socket.emit('join', currentSessionId);
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    clearBtn.classList.remove('hidden');
                    showAlert('Starting your bot...', 'info');
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Failed to start session', 'error');
            }
        });

        stopBtn.addEventListener('click', async () => {
            if (!currentSessionId) return;
            
            if (confirm('Are you sure you want to stop your bot?')) {
                try {
                    await fetch('/api/stop', { 
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ sessionId: currentSessionId })
                    });
                } catch (error) {
                    showAlert('Failed to stop session', 'error');
                }
            }
        });

        clearBtn.addEventListener('click', async () => {
            if (!currentSessionId) return;
            
            if (confirm('‚ö†Ô∏è This will LOGOUT and DELETE your saved session. You will need to scan QR code again next time. Continue?')) {
                try {
                    const res = await fetch('/api/clear', { 
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ sessionId: currentSessionId })
                    });
                    const data = await res.json();
                    
                    if (!res.ok) {
                        showAlert(data.error, 'error');
                    }
                } catch (error) {
                    showAlert('Failed to clear session', 'error');
                }
            }
        });

        function updateUI(data) {
            if (data.exists) {
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                clearBtn.classList.remove('hidden');
                
                if (data.isReady) {
                    updateStatus('ready');
                    readyArea.classList.remove('hidden');
                    messageLog.classList.remove('hidden');
                    qrArea.classList.add('hidden');
                } else {
                    updateStatus('active');
                }
            } else {
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                clearBtn.classList.add('hidden');
                updateStatus('inactive');
            }
        }

        function updateStatus(status) {
            statusBadge.className = 'status-badge';
            
            if (status === 'inactive') {
                statusBadge.classList.add('status-inactive');
                statusBadge.textContent = '‚óè Inactive';
            } else if (status === 'active') {
                statusBadge.classList.add('status-active');
                statusBadge.textContent = '‚óè Active';
            } else if (status === 'ready') {
                statusBadge.classList.add('status-ready');
                statusBadge.textContent = '‚óè Connected';
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }

        function addMessage(type, name, message, timestamp) {
            const item = document.createElement('div');
            item.className = `message-item message-${type}`;
            
            const time = new Date(timestamp).toLocaleTimeString();
            const prefix = type === 'received' ? 'üì© From' : '‚úÖ To';
            
            item.innerHTML = `
                <strong>${prefix}: ${name}</strong><br>
                ${message}
                <div class="message-time">${time}</div>
            `;
            
            messageList.insertBefore(item, messageList.firstChild);
        }

        function resetUI() {
            qrArea.classList.add('hidden');
            readyArea.classList.add('hidden');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            clearBtn.classList.add('hidden');
            updateStatus('inactive');
        }

        // File upload handler
        const uploadFileBtn = document.getElementById('uploadFileBtn');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');

        uploadFileBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            
            if (!file) {
                uploadStatus.textContent = '‚ö†Ô∏è Please select a file first';
                uploadStatus.style.color = '#dc3545';
                return;
            }

            // Check file size (max 25MB)
            if (file.size > 25 * 1024 * 1024) {
                uploadStatus.textContent = '‚ö†Ô∏è File too large. Max size: 25MB';
                uploadStatus.style.color = '#dc3545';
                return;
            }

            uploadStatus.textContent = '‚è≥ Uploading...';
            uploadStatus.style.color = '#007bff';
            uploadFileBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    uploadStatus.textContent = `‚úÖ ${result.message}`;
                    uploadStatus.style.color = '#28a745';
                    
                    if (result.analysis) {
                        uploadStatus.textContent += `\n\nü§ñ AI Response: ${result.analysis}`;
                    }
                    
                    fileInput.value = '';
                } else {
                    uploadStatus.textContent = `‚ùå ${result.error || 'Upload failed'}`;
                    uploadStatus.style.color = '#dc3545';
                }
            } catch (error) {
                uploadStatus.textContent = `‚ùå Error: ${error.message}`;
                uploadStatus.style.color = '#dc3545';
            } finally {
                uploadFileBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
